name: Build

permissions:
  contents: write

on:
  release:
    types: [published]
  workflow_dispatch:

jobs:
  build-linux:
    runs-on: ubuntu-latest
    steps:
      - uses: actions/checkout@v4

      - name: Install uv
        uses: astral-sh/setup-uv@v4

      - name: Set up Python
        run: uv python install 3.13

      - name: Install dependencies
        run: uv sync --dev

      - name: Build executable
        run: uv run pyinstaller housekeeper.spec

      - name: Rename executable
        run: mv dist/housekeeper dist/housekeeper-linux-amd64

      - name: Install nfpm
        run: |
          curl -sfL https://github.com/goreleaser/nfpm/releases/download/v2.41.1/nfpm_2.41.1_linux_amd64.tar.gz | tar xz -C /usr/local/bin nfpm

      - name: Build deb package
        run: nfpm package -p deb -f installer/linux/nfpm.yaml -t dist/

      - name: Build rpm package
        run: nfpm package -p rpm -f installer/linux/nfpm.yaml -t dist/

      - name: Upload executable
        uses: actions/upload-artifact@v4
        with:
          name: housekeeper-linux-amd64
          path: dist/housekeeper-linux-amd64

      - name: Upload deb
        uses: actions/upload-artifact@v4
        with:
          name: housekeeper-linux-amd64-deb
          path: dist/*.deb

      - name: Upload rpm
        uses: actions/upload-artifact@v4
        with:
          name: housekeeper-linux-amd64-rpm
          path: dist/*.rpm

      - name: Upload release assets
        if: github.event_name == 'release'
        uses: softprops/action-gh-release@v2
        with:
          files: |
            dist/housekeeper-linux-amd64
            dist/*.deb
            dist/*.rpm

  build-macos-intel:
    runs-on: macos-15-intel
    steps:
      - uses: actions/checkout@v4

      - name: Install uv
        uses: astral-sh/setup-uv@v4

      - name: Set up Python
        run: uv python install 3.13

      - name: Install dependencies
        run: uv sync --dev

      - name: Build executable
        run: uv run pyinstaller housekeeper.spec

      - name: Rename executable
        run: mv dist/housekeeper dist/housekeeper-macos-amd64

      - name: Create DMG
        run: |
          mkdir -p dist/dmg
          cp dist/housekeeper-macos-amd64 dist/dmg/housekeeper
          hdiutil create -volname "Housekeeper" -srcfolder dist/dmg -ov -format UDZO dist/housekeeper-macos-amd64.dmg

      - name: Upload executable
        uses: actions/upload-artifact@v4
        with:
          name: housekeeper-macos-amd64
          path: dist/housekeeper-macos-amd64

      - name: Upload DMG
        uses: actions/upload-artifact@v4
        with:
          name: housekeeper-macos-amd64-dmg
          path: dist/housekeeper-macos-amd64.dmg

      - name: Upload release assets
        if: github.event_name == 'release'
        uses: softprops/action-gh-release@v2
        with:
          files: |
            dist/housekeeper-macos-amd64
            dist/housekeeper-macos-amd64.dmg

  build-macos-arm:
    runs-on: macos-latest
    steps:
      - uses: actions/checkout@v4

      - name: Install uv
        uses: astral-sh/setup-uv@v4

      - name: Set up Python
        run: uv python install 3.13

      - name: Install dependencies
        run: uv sync --dev

      - name: Build executable
        run: uv run pyinstaller housekeeper.spec

      - name: Rename executable
        run: mv dist/housekeeper dist/housekeeper-macos-arm64

      - name: Create DMG
        run: |
          mkdir -p dist/dmg
          cp dist/housekeeper-macos-arm64 dist/dmg/housekeeper
          hdiutil create -volname "Housekeeper" -srcfolder dist/dmg -ov -format UDZO dist/housekeeper-macos-arm64.dmg

      - name: Upload executable
        uses: actions/upload-artifact@v4
        with:
          name: housekeeper-macos-arm64
          path: dist/housekeeper-macos-arm64

      - name: Upload DMG
        uses: actions/upload-artifact@v4
        with:
          name: housekeeper-macos-arm64-dmg
          path: dist/housekeeper-macos-arm64.dmg

      - name: Upload release assets
        if: github.event_name == 'release'
        uses: softprops/action-gh-release@v2
        with:
          files: |
            dist/housekeeper-macos-arm64
            dist/housekeeper-macos-arm64.dmg

  build-windows:
    runs-on: windows-latest
    steps:
      - uses: actions/checkout@v4

      - name: Install uv
        uses: astral-sh/setup-uv@v4

      - name: Set up Python
        run: uv python install 3.13

      - name: Install dependencies
        run: uv sync --dev

      - name: Build executable
        run: uv run pyinstaller housekeeper.spec

      - name: Rename executable
        run: mv dist/housekeeper.exe dist/housekeeper-windows-amd64.exe

      - name: Build installer
        run: iscc installer/windows/housekeeper.iss

      - name: Upload executable
        uses: actions/upload-artifact@v4
        with:
          name: housekeeper-windows-amd64
          path: dist/housekeeper-windows-amd64.exe

      - name: Upload installer
        uses: actions/upload-artifact@v4
        with:
          name: housekeeper-windows-amd64-setup
          path: dist/housekeeper-windows-amd64-setup.exe

      - name: Upload release assets
        if: github.event_name == 'release'
        uses: softprops/action-gh-release@v2
        with:
          files: |
            dist/housekeeper-windows-amd64.exe
            dist/housekeeper-windows-amd64-setup.exe