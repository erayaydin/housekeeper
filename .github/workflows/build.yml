name: Build

permissions:
  contents: write

on:
  release:
    types: [published]
  workflow_dispatch:

jobs:
  build-linux:
    runs-on: ubuntu-latest
    steps:
      - uses: actions/checkout@v4

      - name: Get version
        id: version
        run: echo "version=$(grep -oP 'version = "\K[^"]+' pyproject.toml | head -1)" >> $GITHUB_OUTPUT

      - name: Install uv
        uses: astral-sh/setup-uv@v4

      - name: Set up Python
        run: uv python install 3.13

      - name: Install dependencies
        run: uv sync --dev

      - name: Build executable
        run: uv run pyinstaller housekeeper.spec

      - name: Rename executable
        run: mv dist/housekeeper dist/housekeeper-${{ steps.version.outputs.version }}-linux-amd64

      - name: Install nfpm
        run: |
          curl -sfL https://github.com/goreleaser/nfpm/releases/download/v2.44.1/nfpm_2.44.1_Linux_x86_64.tar.gz | tar xz -C /usr/local/bin nfpm

      - name: Update nfpm config with version
        run: |
          sed -i 's|dist/housekeeper-linux-amd64|dist/housekeeper-${{ steps.version.outputs.version }}-linux-amd64|' installer/linux/nfpm.yaml

      - name: Build deb package
        run: nfpm package -p deb -f installer/linux/nfpm.yaml -t dist/
        env:
          VERSION: ${{ steps.version.outputs.version }}

      - name: Build rpm package
        run: nfpm package -p rpm -f installer/linux/nfpm.yaml -t dist/
        env:
          VERSION: ${{ steps.version.outputs.version }}

      - name: Upload executable
        uses: actions/upload-artifact@v4
        with:
          name: housekeeper-${{ steps.version.outputs.version }}-linux-amd64
          path: dist/housekeeper-${{ steps.version.outputs.version }}-linux-amd64

      - name: Upload deb
        uses: actions/upload-artifact@v4
        with:
          name: housekeeper-${{ steps.version.outputs.version }}-linux-amd64-deb
          path: dist/*.deb

      - name: Upload rpm
        uses: actions/upload-artifact@v4
        with:
          name: housekeeper-${{ steps.version.outputs.version }}-linux-amd64-rpm
          path: dist/*.rpm

      - name: Upload release assets
        if: github.event_name == 'release'
        uses: softprops/action-gh-release@v2
        with:
          files: |
            dist/housekeeper-${{ steps.version.outputs.version }}-linux-amd64
            dist/*.deb
            dist/*.rpm

  build-macos-intel:
    runs-on: macos-15-intel
    steps:
      - uses: actions/checkout@v4

      - name: Get version
        id: version
        run: echo "version=$(grep -oE 'version = "[^"]+"' pyproject.toml | head -1 | cut -d'"' -f2)" >> $GITHUB_OUTPUT

      - name: Install uv
        uses: astral-sh/setup-uv@v4

      - name: Set up Python
        run: uv python install 3.13

      - name: Install dependencies
        run: uv sync --dev

      - name: Build app bundle
        run: uv run pyinstaller housekeeper.spec

      - name: Create DMG
        run: |
          chmod +x installer/macos/create_dmg.sh
          ./installer/macos/create_dmg.sh ${{ steps.version.outputs.version }} amd64

      - name: Upload app bundle
        uses: actions/upload-artifact@v4
        with:
          name: Housekeeper-${{ steps.version.outputs.version }}-macos-amd64-app
          path: dist/Housekeeper.app

      - name: Upload DMG
        uses: actions/upload-artifact@v4
        with:
          name: Housekeeper-${{ steps.version.outputs.version }}-macos-amd64-dmg
          path: dist/Housekeeper-${{ steps.version.outputs.version }}-macos-amd64.dmg

      - name: Upload release assets
        if: github.event_name == 'release'
        uses: softprops/action-gh-release@v2
        with:
          files: |
            dist/Housekeeper-${{ steps.version.outputs.version }}-macos-amd64.dmg

  build-macos-arm:
    runs-on: macos-latest
    steps:
      - uses: actions/checkout@v4

      - name: Get version
        id: version
        run: echo "version=$(grep -oE 'version = "[^"]+"' pyproject.toml | head -1 | cut -d'"' -f2)" >> $GITHUB_OUTPUT

      - name: Install uv
        uses: astral-sh/setup-uv@v4

      - name: Set up Python
        run: uv python install 3.13

      - name: Install dependencies
        run: uv sync --dev

      - name: Build app bundle
        run: uv run pyinstaller housekeeper.spec

      - name: Create DMG
        run: |
          chmod +x installer/macos/create_dmg.sh
          ./installer/macos/create_dmg.sh ${{ steps.version.outputs.version }} arm64

      - name: Upload app bundle
        uses: actions/upload-artifact@v4
        with:
          name: Housekeeper-${{ steps.version.outputs.version }}-macos-arm64-app
          path: dist/Housekeeper.app

      - name: Upload DMG
        uses: actions/upload-artifact@v4
        with:
          name: Housekeeper-${{ steps.version.outputs.version }}-macos-arm64-dmg
          path: dist/Housekeeper-${{ steps.version.outputs.version }}-macos-arm64.dmg

      - name: Upload release assets
        if: github.event_name == 'release'
        uses: softprops/action-gh-release@v2
        with:
          files: |
            dist/Housekeeper-${{ steps.version.outputs.version }}-macos-arm64.dmg

  build-windows:
    runs-on: windows-latest
    steps:
      - uses: actions/checkout@v4

      - name: Get version
        id: version
        shell: pwsh
        run: |
          $version = (Select-String -Path pyproject.toml -Pattern 'version = "([^"]+)"' | Select-Object -First 1).Matches.Groups[1].Value
          echo "version=$version" >> $env:GITHUB_OUTPUT

      - name: Install uv
        uses: astral-sh/setup-uv@v4

      - name: Set up Python
        run: uv python install 3.13

      - name: Install dependencies
        run: uv sync --dev

      - name: Build executable
        run: uv run pyinstaller housekeeper.spec

      - name: Rename executable
        run: mv dist/housekeeper.exe dist/housekeeper-${{ steps.version.outputs.version }}-windows-amd64.exe

      - name: Update Inno Setup version
        shell: pwsh
        run: |
          (Get-Content installer/windows/housekeeper.iss) -replace 'housekeeper-windows-amd64', 'housekeeper-${{ steps.version.outputs.version }}-windows-amd64' | Set-Content installer/windows/housekeeper.iss

      - name: Build installer
        run: iscc installer/windows/housekeeper.iss

      - name: Upload executable
        uses: actions/upload-artifact@v4
        with:
          name: housekeeper-${{ steps.version.outputs.version }}-windows-amd64
          path: dist/housekeeper-${{ steps.version.outputs.version }}-windows-amd64.exe

      - name: Upload installer
        uses: actions/upload-artifact@v4
        with:
          name: housekeeper-${{ steps.version.outputs.version }}-windows-amd64-setup
          path: dist/housekeeper-${{ steps.version.outputs.version }}-windows-amd64-setup.exe

      - name: Upload release assets
        if: github.event_name == 'release'
        uses: softprops/action-gh-release@v2
        with:
          files: |
            dist/housekeeper-${{ steps.version.outputs.version }}-windows-amd64.exe
            dist/housekeeper-${{ steps.version.outputs.version }}-windows-amd64-setup.exe